---
title: Тестирование отказоустойчивости в {{ yandex-cloud }}
description: Руководство по проведению учений по отказу зоны в облаке
keywords:
  - тестирование
  - отказ зоны доступности
  - chaos engineering
  - отказоустойчивость
  - нагрузочное тестирование
---

# Руководство по тестированию отказоустойчивости в {{ yandex-cloud }}

Данное руководство описывает практическую часть рекомендаций по тестированию отказоустойчивости, которые содержатся в статье [Рекомендации по отказоустойчивости в {{ yandex-cloud }}](./fault-tolerance.md). Предполагается, что принципы построения тестируемой инфраструктуры не противоречат принципам, изложенным в статье.

## Цели тестирования {#goals}

В руководстве описывается методология проведения учений по отказу зоны в облаке, которая позволит:

* исследовать поведение системы во время отказа;
* оценить способность системы переживать отключение одной зоны доступности;
* выявить неявные зависимости и уязвимости;
* собрать информацию о симптомах отказа;
* поверить способность системы к быстрому восстановлению.

Исследование отказа ограничено случаем полного отказа зоны доступности. Частичные отказы выходят за рамки этой статьи из-за их многообразия.

## Подготовка к тестированию {#preparation}

### Среда тестирования {#test-environment}

1. Соответствие продуктовой среде:
   
   {% note warning %}
       
     Не рекомендуется проводить тестирование сразу в продуктовом окружении, сначала следует провести учения на тестовой среде.

   {% endnote %}
   
   * Тестовая среда должна максимально соответствовать продуктовой.
   * Нагрузка на тестовую среду должна имитировать нагрузку на продуктовую. Для имитации нагрузки используйте инструменты нагрузочного тестирования, например, [Yandex Load Testing](/services/load-testing).
   * Рекомендуется использовать [Infrastructure as Code](https://yandex.cloud/ru/blog/cloud-control-tools#iac) для автоматизации создания тестовых сред.

1. Для оптимизации затрат в тестовой среде рекомендуется:
   * использовать NRD-диски вместо SSD-IO;
   * использовать прерываемые виртуальные машины;
   * динамически создавать среды только на время тестирования;
   * автоматически освобождать ресурсы после завершения тестов;
   * использовать компоненты без SLA для снижения затрат.

### Требования к проведению тестирования {#requirements}

1. Наличие системы мониторинга, которая позволит оценить результаты тестирования. 
1. Сохранение результатов тестирования для ретроспективного анализа.
1. Тестирования должны проводиться на регулярной основе.
1. [CLI Yandex Cloud (yc)](https://yandex.cloud/ru/docs/cli/quickstart) версии 0.154.0 или более новой.

### Инструменты тестирования {#testing-tools}

В данном документе рассматривается тестирование с помощью инструментов отключения балансировки в зоне доступности для [{{ network-load-balancer-name }}](https://yandex.cloud/ru/docs/network-load-balancer/operations/manage-zone/disable-enable-zone) и для [{{ alb-name }}](https://yandex.cloud/ru/docs/application-load-balancer/operations/manage-zone/start-and-cancel-shift). 

В качестве дополнительного инструмента обеспечения изоляции отключаемой зоны рекомендуется использовать [Группы безопасности VPC](https://yandex.cloud/ru/docs/vpc/concepts/security-groups).
**Важно**: при использовании [Группы безопасности VPC](https://yandex.cloud/ru/docs/vpc/concepts/security-groups) следует учитывать следующие особенности:
- В группах безопасности поддерживаются только разрешающие правила, поэтому для блокировки трафика необходимо предусмотреть отдельный набор правил, разрешающих трафик между зонами, которые будут удаляться в момент организации блокировки. 
- Удаление разрешающих правил из группы безопасности блокирует установку новых сетевых соединений, но не разрывает уже установленные соединения.

## Методология проведения тестирования {#methodology}

### Подготовка

1. Подготовьте, если требуется, окружение к проведению тестирования. 
1. Выберите зону доступности, из которой будет уводиться трафик. Например `ru-central1-b`.
1. Определите продолжительность теста. Отключение зоны балансировщика может быть как постоянным, так и на заданный период времени (от 1 минуты до 72 часов). Например, 30 минут.
1. Получите список балансировщиков, которые будут принимать участие в тестировании:

   ```
   yc load-balancer nlb list
   ```

### Запуск тестирования 

1. Отключите доставку трафика в выбранную зону доступности для каждого выбранного балансировщика. Для отключения балансировки трафика в выбранную зону используется команда disable-zones:

   ```
   yc load-balancer nlb enpmq******** disable-zones --zone-ids=ru-central1-b --duration 30m
   ```

   Пример ответа (обратите внимание на блок `disable_zone_statuses`):

   ```
   id: enpmq********
   ...
   disable_zone_statuses:
       - zone_id: ru-central1-b
       disabled_until: "2025-06-07T04:10:02.679608678Z"
   ```

   Команда поддерживает одновременное отключение сразу нескольких зон.

   При повторном выполнении команды период времени на блокировку будет снова выставлен в 30 минут от текущего момента.

   Если не указывать параметр `--duration`, балансировка трафика в зону доступности будет заблокирована без ограничения по времени.

   {% note warning %}

    Команда `disable-zones` отключает только балансировку трафика в выбранную зону и только для указанного балансировщика. Эта команда не влияет на сетевой трафик внутри зоны и между зонами доступности. При необходимости такой блокировки используйте [Группы безопасности VPC](https://yandex.cloud/ru/docs/vpc/concepts/security-groups).

   {% endnote %}

### Контроль прохождения

1. Получите информацию о состоянии блокировки:

   ```
   yc load-balancer nlb get enpmq********
   ```

   Пример ответа:

   ```
   allow_zonal_shift: true
   zonal_shift_resource_type: PRIVATE
   disable_zone_statuses:   
     - zone_id: ru-central1-b     
     disabled_until: "2025-06-07T04:10:02.679608678Z"
   ```

1. Проконтролируйте, что трафик перестал поступать в выбранную зону. Это можно сделать в сервисе [мониторинга](../monitoring/), выведя на график суммарный трафик на интерфейсах виртуальных машин с группировкой по зонам доступности. 

   > На текущий момент нет возможности получить одним простым запросом к сервису мониторинга график распределения трафика по зонам. Чтобы решить эту задачу:
   > 1. Создайте график в сервисе мониторинга.
   > 1. Составьте списки id виртуальных машин для зоны `ru-central1-a`, например, с помощью команды
   >    ```
   >    yc compute instance list --jq '[.[] | select(.zone_id=="ru-central1-a") | .id ] | join("|")'`
   >    ```
   >    Результатом выполнения команды будет однострочный список id виртуальных машин, разделенных `|`. Пример: `fhm**********uv5|fhm**********aab|fhm**********ui1|...`. 
   > 1. В графике мониторинга добавьте запрос 
   >    ```
   >    alias(series_sum("network_received_packets"{folderId = "b1g**********", service = "compute", resource_type = "vm", resource_id = "<Полученный на предыдущем шаге список id виртуальных машин, разделенных |>"}), "ru-central1-a")`
   >    ```
   > 1. Повторите шаги 2 и 3 для зон `ru-central1-b` и `ru-central1-d`.
   > 1. Выполните запросы.
 
### Завершение тестирования 

1. Выполните команду `enable-zones` для обратного включения балансировки трафика в выбранную зону:

   ```
   yc load-balancer nlb enpmq******** enable-zones --zone-ids=ru-central1-b
   ```

1. Проконтролируйте, что данные начали поступать в выбранную зону.

   > Важно помнить, что существует ограничение по времени для операции повторного выключения балансировки после включения обратно. Повторное отключение после обратного включение может быть выполнено не ранее, чем через 2 минуты. 

### {{ alb-name }}

Синтаксис и семантика команд отключения и обратного включения балансировки для {{ alb-name }} соответствуют командам для {{ network-load-balancer-name }}. 

## Заключение {#conclusion}

Рекомендуется проводить тестирование отказоустойчивости на регулярной основе, документировать результаты и постоянно улучшать процессы на основе полученного опыта.
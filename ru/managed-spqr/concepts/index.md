---
title: Взаимосвязь ресурсов сервиса {{ mspqr-full-name }}
description: '{{ SPQR }} — система для горизонтального масштабирования {{ PG }} через шардирование. Кластер {{ SPQR }} состоит из шардов, роутера и координатора.'
---

# Взаимосвязь ресурсов в {{ mspqr-full-name }}

{% include [preview](../../_includes/note-service-preview.md) %}

{{ SPQR }} — система для горизонтального масштабирования {{ PG }} через [шардирование](../../glossary/sharding.md). Фактически это несколько кластеров {{ PG }}, объединенных в один кластер {{ SPQR }}.

[Кластер](../../glossary/cluster.md) {{ mspqr-name }} состоит из _шардов_, _роутера_ и _координатора_ (опционально). Роутеры и координаторы запускаются на _хостах_ — виртуальных машинах с выделенными вычислительными ресурсами и зарезервированным объемом хранилища данных.

## Шард {#shard}

Шард — это кластер {{ mpg-name }}, расположенный в том же [каталоге](../../resource-manager/concepts/resources-hierarchy.md#folder) и [облачной сети](../../vpc/concepts/network.md), что и кластер {{ mspqr-name }}.

Шардов может быть один или несколько. Максимальное число шардов не ограничено и не зависит от типа шардирования, которое используется в кластере.

Каждый шард хранит независимый фрагмент данных. Данные распределяются по шардам согласно ключу шардирования.

Запросы направляются к шарду в зависимости от данных, которые он содержит. За распределение запросов между шардами отвечает роутер.

## Роутер {#router}

Роутер — основной компонент кластера {{ mspqr-name }}, отвечающий за маршрутизацию запросов.

Клиент подключается к роутеру и отправляет запросы по протоколу {{ PG }}. Роутер анализирует запрос, перенаправляет его на шард, где хранятся нужные данные, получает результат выполнения запроса и возвращает его клиенту.

Роутер находит нужный шард с помощью правил шардирования. Если в кластере есть координатор, то правила поставляет он. Если координатора нет, правила задаются вручную для каждого роутера и хранятся в его оперативной памяти до перезагрузки.

При создании кластера вы можете выбрать тип шардирования — стандартное или расширенное. Если выбрать стандартное, в кластер будет добавлены хосты `INFRA`, объединяющие роли роутера и координатора. Чтобы обеспечить отказоустойчивость такого кластера, рекомендуется создать не менее трех хостов `INFRA` в разных зонах доступности. Максимальное число хостов `INFRA` — семь.

Если выбрать расширенное шардирование, роутерам будут выделены отдельные хосты `ROUTER`. Число роутеров, расположенных на таких хостах, не ограничено.

## Координатор {#coordinator}

Координатор — это компонент кластера {{ mspqr-name }}, отвечающий за хранение правил шардирования и балансировку нагрузки на шарды.

Наличие координатора зависит от типа шардирования кластера:

* При стандартном шардировании координатор — обязательный компонент, его роль выполняет хост `INFRA`. Чтобы обеспечить отказоустойчивость такого кластера, рекомендуется создать не менее трех хостов `INFRA` в разных зонах доступности. Максимальное число хостов `INFRA` — семь.

* При расширенном шардировании координатор — опциональный компонент, его роль выполняет хост `COORDINATOR`. Чтобы обеспечить отказоустойчивость кластера, рекомендуется создать три хоста `COORDINATOR` в разных зонах доступности. Максимальное число хостов `COORDINATOR` — пять.

Координаторы хранят правила шардирования в базе данных QDB, запущенной на хостах `INFRA` или `COORDINATOR`. Эта база данных представляет собой кластер [etcd](https://etcd.io), в котором изменения данных согласуются по [алгоритму консенсуса](https://raft.github.io).

С помощью координатора вы можете задавать и редактировать правила шардирования для всех роутеров сразу. Если изменить правила на одном из координаторов, обновленная информация будет передана другим координаторам и роутерам.


